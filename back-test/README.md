# åŠ å¯†è´§å¸äº¤æ˜“ç­–ç•¥å›æµ‹ç³»ç»Ÿ

## æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªåŸºäº backtrader æ¡†æ¶çš„ä¸“ä¸šåŠ å¯†è´§å¸äº¤æ˜“ç­–ç•¥å›æµ‹ç³»ç»Ÿã€‚ç³»ç»Ÿä» MySQL æ•°æ®åº“è¯»å– K çº¿æ•°æ®ï¼ŒåŠ¨æ€åŠ è½½ç­–ç•¥æ–‡ä»¶ï¼Œæ‰§è¡Œå›æµ‹å¹¶è®¡ç®—å„ç§æ€§èƒ½æŒ‡æ ‡ã€‚

### ä¸»è¦ç‰¹æ€§

- ğŸš€ **é«˜ç²¾åº¦è®¡ç®—**ï¼šä½¿ç”¨ backtrader å†…ç½®åˆ†æå™¨ç¡®ä¿æŒ‡æ ‡è®¡ç®—å‡†ç¡®æ€§
- ğŸ“Š **åŠ¨æ€æ—¶é—´æ¡†æ¶**ï¼šæ ¹æ®æ•°æ®é—´éš”è‡ªåŠ¨è®¾ç½®åˆ†æå™¨å‚æ•°
- ğŸ”§ **çµæ´»é…ç½®**ï¼šæ”¯æŒå¤šç§æ—¶é—´é—´éš”ï¼ˆ1m-1Mï¼‰å’Œç­–ç•¥åŠ¨æ€åŠ è½½
- ğŸ“ˆ **å…¨é¢æŒ‡æ ‡**ï¼šå¤æ™®æ¯”ç‡ã€æœ€å¤§å›æ’¤ã€Calmar æ¯”ç‡ã€VWR ç­‰ä¸“ä¸šæŒ‡æ ‡
- ğŸ¯ **æ˜“äºæ‰©å±•**ï¼šæ¨¡å—åŒ–è®¾è®¡ï¼Œæ”¯æŒè‡ªå®šä¹‰ç­–ç•¥å’Œåˆ†æå™¨

## æ–‡ä»¶ç»“æ„

```
back-test/
â”œâ”€â”€ index.py                      # ä¸»å›æµ‹å¼•æ“
â”œâ”€â”€ README.md                     # ä½¿ç”¨è¯´æ˜æ–‡æ¡£
â”œâ”€â”€ requirements.txt              # Pythonä¾èµ–åŒ…
â”œâ”€â”€ ANALYZER_CONFIGURATION.md    # åˆ†æå™¨é…ç½®è¯´æ˜
â””â”€â”€ strategy/                     # ç­–ç•¥æ–‡ä»¶å¤¹
    â”œâ”€â”€ simple_ma.py             # ç®€å•ç§»åŠ¨å¹³å‡ç­–ç•¥
    â”œâ”€â”€ rsi_ma.py                # RSI + ç§»åŠ¨å¹³å‡ç­–ç•¥
    â”œâ”€â”€ buy_hold.py              # ä¹°å…¥æŒæœ‰ç­–ç•¥
    â””â”€â”€ test_predictable.py      # å¯é¢„æµ‹æµ‹è¯•ç­–ç•¥
```

## ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬ç”¨æ³•

```bash
python index.py --currency BTCUSDT --time_interval 1h --strategy_name simple_ma
```

### å‚æ•°è¯´æ˜

- `--currency`: è´§å¸å¯¹ï¼Œå¦‚ BTCUSDTã€ETHUSDT ç­‰
- `--time_interval`: æ—¶é—´é—´éš”ï¼Œæ”¯æŒæ ¼å¼ï¼š
  - **åˆ†é’Ÿçº§**ï¼š1m, 5m, 15m, 30m
  - **å°æ—¶çº§**ï¼š1h, 2h, 4h, 6h, 8h, 12h
  - **æ—¥çº§**ï¼š1d, 1D
  - **å‘¨çº§**ï¼š1w, 1W
  - **æœˆçº§**ï¼š1Mï¼ˆæ³¨æ„å¤§å†™ï¼‰
- `--strategy_name`: ç­–ç•¥åç§°ï¼Œå¯¹åº” strategy æ–‡ä»¶å¤¹ä¸‹çš„ Python æ–‡ä»¶åï¼ˆæ— éœ€ .py åç¼€ï¼‰

### è¾“å‡ºæ ¼å¼

ç³»ç»Ÿä¼šè¾“å‡º JSON æ ¼å¼çš„å›æµ‹ç»“æœï¼š

```json
{
  "currency": "BTCUSDT",
  "time_interval": "4h",
  "sharpe_ratio": 0.024432065173515156,
  "trade_count": 45,
  "trades": [
    {
      "time": "2024-08-28 04:00:00",
      "balance": 10423.171931051264,
      "price": 59337.41,
      "size": 0.0,
      "pnl": 442.61454239163027,
      "pnlcomm": 423.1719310512653,
      "commission": 19.442611340364987
    }
  ],
  "total_commission": 1121.37,
  "max_drawdown": 0.28259016548838395,
  "winning_percentage": 0.4,
  "init_balance": 10000.0,
  "final_balance": 13734.44,
  "total_return": 0.3734,
  "annual_return": 0.4112576108437447,
  "calmar_ratio": 0.0,
  "vwr": 11.531614960717375,
  "data_points": 2189,
  "start_date": "2024-08-09 00:00:00",
  "end_date": "2025-08-11 00:00:00"
}
```

### å­—æ®µè¯´æ˜

#### åŸºç¡€ä¿¡æ¯
- `currency`: è´§å¸å¯¹
- `time_interval`: æ—¶é—´é—´éš”
- `data_points`: æ•°æ®ç‚¹æ•°é‡
- `start_date`: å›æµ‹å¼€å§‹æ—¥æœŸ
- `end_date`: å›æµ‹ç»“æŸæ—¥æœŸ

#### è´¢åŠ¡æŒ‡æ ‡
- `init_balance`: åˆå§‹èµ„é‡‘
- `final_balance`: æœ€ç»ˆèµ„é‡‘
- `total_return`: æ€»æ”¶ç›Šç‡ï¼ˆå°æ•°å½¢å¼ï¼Œ0.3734 è¡¨ç¤º 37.34%ï¼‰
- `annual_return`: å¹´åŒ–æ”¶ç›Šç‡
- `total_commission`: æ€»æ‰‹ç»­è´¹

#### é£é™©æŒ‡æ ‡
- `sharpe_ratio`: å¤æ™®æ¯”ç‡ï¼ˆä½¿ç”¨ backtrader å†…ç½®åˆ†æå™¨è®¡ç®—ï¼‰
- `max_drawdown`: æœ€å¤§å›æ’¤ï¼ˆå°æ•°å½¢å¼ï¼Œ0.28 è¡¨ç¤º 28%ï¼‰
- `calmar_ratio`: Calmar æ¯”ç‡ï¼ˆå¹´åŒ–æ”¶ç›Šç‡/æœ€å¤§å›æ’¤ï¼‰
- `vwr`: å˜å¼‚åŠ æƒæ”¶ç›Šç‡ï¼ˆVariability-Weighted Returnï¼‰

#### äº¤æ˜“ç»Ÿè®¡
- `trade_count`: äº¤æ˜“æ¬¡æ•°
- `winning_percentage`: èƒœç‡ï¼ˆå°æ•°å½¢å¼ï¼Œ0.4 è¡¨ç¤º 40%ï¼‰
- `trades`: æ¯ç¬”äº¤æ˜“çš„è¯¦ç»†ä¿¡æ¯æ•°ç»„
  - `time`: äº¤æ˜“æ—¶é—´
  - `balance`: äº¤æ˜“åè´¦æˆ·ä½™é¢
  - `price`: äº¤æ˜“ä»·æ ¼
  - `size`: äº¤æ˜“æ•°é‡ï¼ˆ0.0 è¡¨ç¤ºå¹³ä»“ï¼‰
  - `pnl`: æ¯›åˆ©æ¶¦
  - `pnlcomm`: å‡€åˆ©æ¶¦ï¼ˆæ‰£é™¤æ‰‹ç»­è´¹ï¼‰
  - `commission`: æ‰‹ç»­è´¹

## ç­–ç•¥å¼€å‘

### ç­–ç•¥æ–‡ä»¶ç»“æ„

æ¯ä¸ªç­–ç•¥æ–‡ä»¶å¿…é¡»åŒ…å«ä¸€ä¸ªåä¸º `Strategy` çš„ç±»ï¼Œç»§æ‰¿è‡ª `backtrader.Strategy`ï¼š

```python
import backtrader as bt

class Strategy(bt.Strategy):
    """ç­–ç•¥ç±»"""
    
    params = (
        ('param1', 10),    # ç­–ç•¥å‚æ•°
        ('param2', 0.95),
    )
    
    def __init__(self):
        """åˆå§‹åŒ–ç­–ç•¥"""
        # è®¡ç®—æŠ€æœ¯æŒ‡æ ‡
        self.sma = bt.indicators.SimpleMovingAverage(
            self.datas[0].close, 
            period=self.params.param1
        )
    
    def next(self):
        """ç­–ç•¥ä¸»é€»è¾‘"""
        # äº¤æ˜“é€»è¾‘
        if not self.position:
            if self.sma[0] > self.sma[-1]:  # ä¸Šå‡è¶‹åŠ¿
                self.buy()
        else:
            if self.sma[0] < self.sma[-1]:  # ä¸‹é™è¶‹åŠ¿
                self.sell()
```

### å†…ç½®ç­–ç•¥

#### 1. simple_ma.py - ç®€å•ç§»åŠ¨å¹³å‡ç­–ç•¥

- ä½¿ç”¨çŸ­æœŸå’Œé•¿æœŸç§»åŠ¨å¹³å‡çº¿
- é‡‘å‰ä¹°å…¥ï¼Œæ­»å‰å–å‡º
- å‚æ•°ï¼šshort_period (10), long_period (30), position_size (0.95)

#### 2. rsi_ma.py - RSI + ç§»åŠ¨å¹³å‡ç­–ç•¥

- ç»“åˆ RSI æŒ‡æ ‡å’Œç§»åŠ¨å¹³å‡çº¿
- RSI è¶…å–ä¸”ä»·æ ¼åœ¨å‡çº¿ä¸Šæ–¹æ—¶ä¹°å…¥
- RSI è¶…ä¹°æˆ–ä»·æ ¼è·Œç ´å‡çº¿æ—¶å–å‡º
- åŒ…å«æ­¢æŸå’Œæ­¢ç›ˆæœºåˆ¶
- å‚æ•°ï¼šrsi_period (14), ma_period (20), stop_loss (0.05), take_profit (0.15)

## æ ¸å¿ƒæŠ€æœ¯ç‰¹æ€§

### åŠ¨æ€æ—¶é—´æ¡†æ¶é…ç½®

ç³»ç»Ÿä¼šæ ¹æ®è¾“å…¥çš„æ—¶é—´é—´éš”è‡ªåŠ¨é…ç½®æ‰€æœ‰åˆ†æå™¨çš„ `timeframe` å’Œ `compression` å‚æ•°ï¼š

| æ—¶é—´é—´éš” | timeframe | compression | è¯´æ˜ |
|---------|-----------|-------------|------|
| 1m | Minutes | 1 | 1 åˆ†é’Ÿ |
| 15m | Minutes | 15 | 15 åˆ†é’Ÿ |
| 1h | Minutes | 60 | 1 å°æ—¶ = 60 åˆ†é’Ÿ |
| 4h | Minutes | 240 | 4 å°æ—¶ = 240 åˆ†é’Ÿ |
| 1d | Days | 1 | 1 å¤© |

### å†…ç½®åˆ†æå™¨ä½¿ç”¨

ç³»ç»Ÿä¼˜å…ˆä½¿ç”¨ backtrader å†…ç½®åˆ†æå™¨ç¡®ä¿è®¡ç®—å‡†ç¡®æ€§ï¼š

#### éœ€è¦æ—¶é—´æ¡†æ¶å‚æ•°çš„åˆ†æå™¨
- **SharpeRatio**: å¤æ™®æ¯”ç‡è®¡ç®—
- **Returns**: æ”¶ç›Šç‡åˆ†æ
- **Calmar**: Calmar æ¯”ç‡è®¡ç®—
- **VWR**: å˜å¼‚åŠ æƒæ”¶ç›Šç‡

#### æ— éœ€é¢å¤–å‚æ•°çš„åˆ†æå™¨
- **DrawDown**: æœ€å¤§å›æ’¤åˆ†æ
- **TradeAnalyzer**: äº¤æ˜“ç»Ÿè®¡åˆ†æ
- **AnnualReturn**: å¹´åŒ–æ”¶ç›Šç‡è®¡ç®—

### æŒ‡æ ‡è®¡ç®—åŸç†

#### å¤æ™®æ¯”ç‡
- ä½¿ç”¨ backtrader å†…ç½® SharpeRatio åˆ†æå™¨
- æ ¹æ®æ•°æ®æ—¶é—´é—´éš”è‡ªåŠ¨è®¾ç½®å¹´åŒ–å‚æ•°
- æ— é£é™©åˆ©ç‡é»˜è®¤ä¸º 0%
- å…¬å¼ï¼š(å¹´åŒ–æ”¶ç›Šç‡ - æ— é£é™©åˆ©ç‡) / å¹´åŒ–æ³¢åŠ¨ç‡

#### æœ€å¤§å›æ’¤
- ä½¿ç”¨ backtrader å†…ç½® DrawDown åˆ†æå™¨
- è®¡ç®—èµ„é‡‘æ›²çº¿ä»å³°å€¼åˆ°è°·å€¼çš„æœ€å¤§è·Œå¹…
- è¿”å›å°æ•°å½¢å¼ï¼ˆ0.28 è¡¨ç¤º 28%ï¼‰

#### Calmar æ¯”ç‡
- å¹´åŒ–æ”¶ç›Šç‡ / æœ€å¤§å›æ’¤
- è¡¡é‡é£é™©è°ƒæ•´åçš„æ”¶ç›Šèƒ½åŠ›
- å€¼è¶Šé«˜è¡¨ç¤ºç­–ç•¥è¶Šä¼˜ç§€

## å®‰è£…å’Œè¿è¡Œ

### ä¾èµ–å®‰è£…

```bash
pip install -r requirements.txt
```

æˆ–æ‰‹åŠ¨å®‰è£…ï¼š

```bash
pip install backtrader pandas numpy pymysql PyYAML
```

### è¿è¡Œç¤ºä¾‹

```bash
# åŸºæœ¬å›æµ‹
python3 index.py --currency BTCUSDT --time_interval 4h --strategy_name simple_ma

# ä¸åŒæ—¶é—´é—´éš”
python3 index.py --currency ETHUSDT --time_interval 1h --strategy_name rsi_ma

# æ—¥çº¿æ•°æ®
python3 index.py --currency BTCUSDT --time_interval 1d --strategy_name buy_hold
```

## ç³»ç»Ÿæ¶æ„

### æ ¸å¿ƒç»„ä»¶

1. **BacktestEngine**: ä¸»å›æµ‹å¼•æ“
   - æ•°æ®åŠ è½½å’Œé¢„å¤„ç†
   - ç­–ç•¥åŠ¨æ€åŠ è½½
   - åˆ†æå™¨é…ç½®ç®¡ç†
   - å›æµ‹æ‰§è¡Œæ§åˆ¶

2. **æ—¶é—´é—´éš”è§£æå™¨**: `_parse_time_interval()`
   - æ™ºèƒ½è§£ææ—¶é—´é—´éš”å­—ç¬¦ä¸²
   - è‡ªåŠ¨æ˜ å°„åˆ° backtrader æ—¶é—´æ¡†æ¶
   - æ”¯æŒå¤šç§æ—¶é—´å•ä½

3. **å†…ç½®åˆ†æå™¨é›†æˆ**:
   - è‡ªåŠ¨é…ç½®åˆ†æå™¨å‚æ•°
   - ç»Ÿä¸€çš„æŒ‡æ ‡æå–æ¥å£
   - å®Œæ•´çš„é”™è¯¯å¤„ç†æœºåˆ¶

### æ•°æ®æµç¨‹

```
MySQL Kçº¿æ•°æ® â†’ æ•°æ®åŠ è½½ â†’ Pandas DataFrame â†’ backtrader Feed â†’ ç­–ç•¥æ‰§è¡Œ â†’ åˆ†æå™¨è®¡ç®— â†’ JSONç»“æœè¾“å‡º
```

## æœ€ä½³å®è·µ

### æ•°æ®å‡†å¤‡
1. **ç¡®ä¿æ•°æ®è´¨é‡**ï¼šMySQL æ•°æ®åº“ä¸­æœ‰è¶³å¤Ÿçš„å†å² K çº¿æ•°æ®
2. **æ—¶é—´ä¸€è‡´æ€§**ï¼šç¡®ä¿æ•°æ®åº“æ—¶é—´å’Œç³»ç»Ÿæ—¶é—´ä¸€è‡´
3. **æ•°æ®å®Œæ•´æ€§**ï¼šé¿å…æ•°æ®ç¼ºå¤±æˆ–å¼‚å¸¸å€¼

### ç­–ç•¥å¼€å‘
1. **æ ‡å‡†ç»“æ„**ï¼šç­–ç•¥æ–‡ä»¶å¿…é¡»åŒ…å« `Strategy` ç±»
2. **å‚æ•°åŒ–è®¾è®¡**ï¼šä½¿ç”¨ `params` å®šä¹‰å¯è°ƒå‚æ•°
3. **æ—¥å¿—è®°å½•**ï¼šåœ¨å…³é”®ä½ç½®æ·»åŠ æ—¥å¿—è¾“å‡º
4. **é£é™©æ§åˆ¶**ï¼šå®ç°æ­¢æŸå’Œä»“ä½ç®¡ç†

### æ€§èƒ½ä¼˜åŒ–
1. **å‘é‡åŒ–è®¡ç®—**ï¼šä¼˜å…ˆä½¿ç”¨ pandas/numpy å‘é‡åŒ–æ“ä½œ
2. **å†…å­˜ç®¡ç†**ï¼šå¤§æ•°æ®é‡æ—¶æ³¨æ„å†…å­˜ä½¿ç”¨
3. **æ•°æ®åº“ä¼˜åŒ–**ï¼šä½¿ç”¨ç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½

## æŠ€æœ¯ä¼˜åŠ¿

### è®¡ç®—å‡†ç¡®æ€§
- âœ… ä½¿ç”¨ backtrader å®˜æ–¹å†…ç½®åˆ†æå™¨
- âœ… åŠ¨æ€æ—¶é—´æ¡†æ¶é…ç½®ç¡®ä¿æŒ‡æ ‡å‡†ç¡®
- âœ… å®Œæ•´çš„å•å…ƒæµ‹è¯•è¦†ç›–

### ç³»ç»Ÿç¨³å®šæ€§
- âœ… å®Œå–„çš„é”™è¯¯å¤„ç†å’Œå¼‚å¸¸æ•è·
- âœ… è¾“å…¥å‚æ•°éªŒè¯å’Œè¾¹ç•Œæ£€æŸ¥
- âœ… æ•°æ®åº“è¿æ¥æ± ç®¡ç†

### æ‰©å±•èƒ½åŠ›
- âœ… æ¨¡å—åŒ–è®¾è®¡ï¼Œæ˜“äºæ·»åŠ æ–°åŠŸèƒ½
- âœ… æ”¯æŒè‡ªå®šä¹‰ç­–ç•¥å’Œåˆ†æå™¨
- âœ… çµæ´»çš„é…ç½®ç³»ç»Ÿ

## å¸¸è§é—®é¢˜

### Q: å¦‚ä½•æ·»åŠ æ–°ç­–ç•¥ï¼Ÿ
A: åœ¨ strategy æ–‡ä»¶å¤¹ä¸‹åˆ›å»ºæ–°çš„ .py æ–‡ä»¶ï¼ŒåŒ…å« Strategy ç±»å³å¯ã€‚ç³»ç»Ÿä¼šè‡ªåŠ¨åŠ è½½ã€‚

### Q: æ”¯æŒå“ªäº›æŠ€æœ¯æŒ‡æ ‡ï¼Ÿ
A: æ”¯æŒ backtrader çš„æ‰€æœ‰å†…ç½®æŒ‡æ ‡ï¼ˆMAã€RSIã€MACDã€å¸ƒæ—å¸¦ç­‰ï¼‰ï¼Œä¹Ÿå¯ä»¥è‡ªå®šä¹‰æŒ‡æ ‡ã€‚

### Q: å¦‚ä½•è°ƒæ•´æ‰‹ç»­è´¹ï¼Ÿ
A: ä¿®æ”¹ BacktestEngine ç±»ä¸­çš„ commission å‚æ•°ï¼Œé»˜è®¤ä¸º 0.001ï¼ˆ0.1%ï¼‰ã€‚

### Q: æ•°æ®ä¸è¶³æ€ä¹ˆåŠï¼Ÿ
A: ç³»ç»Ÿä¼šæç¤ºæ•°æ®ä¸è¶³ï¼Œè¯·ç¡®ä¿æ•°æ®åº“ä¸­æœ‰è¶³å¤Ÿçš„å†å²æ•°æ®ã€‚å»ºè®®è‡³å°‘æœ‰ 100 ä¸ªæ•°æ®ç‚¹ã€‚

### Q: ä¸ºä»€ä¹ˆå¤æ™®æ¯”ç‡å’Œå…¶ä»–ç³»ç»Ÿä¸ä¸€æ ·ï¼Ÿ
A: æœ¬ç³»ç»Ÿä½¿ç”¨ backtrader å†…ç½®åˆ†æå™¨ï¼Œå¹¶æ ¹æ®æ•°æ®æ—¶é—´é—´éš”åŠ¨æ€è®¾ç½®å‚æ•°ï¼Œç¡®ä¿è®¡ç®—å‡†ç¡®æ€§ã€‚

### Q: å¦‚ä½•æŸ¥çœ‹è¯¦ç»†çš„åˆ†æå™¨é…ç½®ï¼Ÿ
A: å‚è€ƒ `ANALYZER_CONFIGURATION.md` æ–‡æ¡£äº†è§£æ‰€æœ‰åˆ†æå™¨çš„è¯¦ç»†é…ç½®è¯´æ˜ã€‚

### Q: æ”¯æŒå“ªäº›æ—¶é—´é—´éš”ï¼Ÿ
A: æ”¯æŒä» 1 åˆ†é’Ÿåˆ° 1 æœˆçš„æ‰€æœ‰å¸¸è§æ—¶é—´é—´éš”ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è§£æå¹¶é…ç½®ç›¸åº”çš„åˆ†æå™¨å‚æ•°ã€‚

---

## æ›´å¤šæ–‡æ¡£

- [åˆ†æå™¨é…ç½®è¯´æ˜](ANALYZER_CONFIGURATION.md)
- [Python ä¾èµ–åŒ…åˆ—è¡¨](requirements.txt)

## ç‰ˆæœ¬å†å²

- **v2.0**: é‡æ„åˆ†æå™¨ç³»ç»Ÿï¼Œä½¿ç”¨ backtrader å†…ç½®åˆ†æå™¨
- **v1.5**: æ·»åŠ åŠ¨æ€æ—¶é—´æ¡†æ¶é…ç½®
- **v1.0**: åŸºç¡€å›æµ‹åŠŸèƒ½å®ç°
