# Python HTTP 服务器

这是一个基于 Flask 的可扩展 HTTP 服务器，支持在任意环境下部署运行。

## 🚀 特性

- **可移植性** - 使用动态路径解析，无硬编码路径，支持任意服务器环境
- **配置驱动** - 端口等配置从 `config/default.yaml` 读取
- **模块化设计** - 路由分离，便于维护和扩展
- **错误处理** - 统一的错误响应格式
- **类型安全** - 完整的 Python 类型注解

## 目录结构

```
app/server/
├── __init__.py           # 模块初始化文件
├── main.py               # 主服务器文件
├── start_server.py       # 启动脚本
├── requirements.txt      # 依赖包列表
├── routes/               # 路由模块
│   ├── __init__.py      # 路由注册管理
│   └── test_routes.py   # 测试路由
└── README.md            # 说明文档
```

## 安装依赖

```bash
cd /Volumes/data/project/open-back/app/server
python3 -m pip install -r requirements.txt
```

## 启动服务器

```bash
# 方法1：使用启动脚本（推荐）
./run.sh

# 方法2：直接运行主文件（自动设置路径）
python3 main.py

# 方法3：使用启动脚本
python3 start_server.py
```

## API接口

### 🔄 统一API设计

所有业务API接口都使用 `/api` 路径，通过POST请求的body来区分具体的路由方法。

**统一请求格式：**
```json
{
    "method": "方法名",
    "data": {
        // 具体参数
    }
}
```

**统一响应格式：**
```json
{
    "success": true/false,
    "message": "错误信息（成功时为空字符串）",
    "data": {
        // 具体返回数据
    }
}
```

### POST /test
测试接口，返回hello world消息

**请求示例：**
```bash
curl -X POST http://127.0.0.1:8081/test \
  -H "Content-Type: application/json" \
  -d '{"test": "data"}'
```

**响应示例：**
```json
{
  "success": true,
  "message": "",
  "data": {
    "endpoint": "/test",
    "method": "POST",
    "received_data": {"test": "data"},
    "message": "hello world"
  }
}
```

### POST /api
统一的业务API接口

#### getStrategy - 获取策略列表

从数据库获取策略数据，支持分页、排序功能。

**请求示例：**
```bash
curl -X POST http://127.0.0.1:8081/api \
  -H "Content-Type: application/json" \
  -d '{
    "method": "getStrategy",
    "data": {
      "page": 1,
      "pageSize": 10,
      "orderBy": "sharpe_ratio",
      "order": "desc"
    }
  }'
```

**参数说明：**
- `page` (number, 可选): 当前页，默认为1
- `pageSize` (number, 可选): 每页数量，默认为20，最大100
- `orderBy` (string, 可选): 排序字段，可选值：
  - `sharpe_ratio` - 夏普比率
  - `findal_balance` - 最终余额
  - `max_drawdown` - 最大回撤
  - `trade_count` - 交易次数
  - `total_commission` - 总手续费
  - `winning_percetage` - 胜率
- `order` (string, 可选): 排序方向，`asc`（升序）或`desc`（降序），默认为`asc`

**响应示例：**
```json
{
  "success": true,
  "message": "",
  "data": {
    "strategies": [
      {
        "id": 4785,
        "name": "2025-09-03_11:13:39_3997",
        "currency": "ETHUSDT",
        "time_interval": "1d",
        "sharpe_ratio": 0.2151745578620255,
        "findal_balance": 10106.48,
        "max_drawdown": 0.001910950442166647,
        "trade_count": 1,
        "total_commission": 9.61,
        "winning_percetage": 1.0,
        "init_balance": 10000.0,
        "reason": "auto-generated by doubao16Thinking",
        "extra": "{...}",
        "created_at": "2025-09-03T11:13:51",
        "updated_at": "2025-09-03T11:13:51"
      }
    ],
    "pagination": {
      "page": 1,
      "pageSize": 10,
      "total": 6880,
      "totalPages": 688,
      "hasNext": true,
      "hasPrev": false
    },
    "sorting": {
      "orderBy": "final_balance",
      "order": "desc"
    }
  }
}
```

### GET /api/health
健康检查接口

**请求示例：**
```bash
curl -X GET http://127.0.0.1:8081/api/health
```

### GET /api/users
获取用户列表（示例接口）

**请求示例：**
```bash
curl -X GET http://127.0.0.1:8081/api/users
```

### POST /api/users
创建新用户（示例接口）

**请求示例：**
```bash
curl -X POST http://127.0.0.1:8081/api/users \
  -H "Content-Type: application/json" \
  -d '{"name": "王五", "email": "wangwu@example.com"}'
```

## 添加新的 API 接口

1. 在 `routes/` 目录下创建新的路由文件，例如 `user_routes.py`
2. 在新文件中定义路由函数
3. 在 `routes/__init__.py` 中导入并注册新的路由

**示例：**

```python
# routes/user_routes.py
from flask import Flask, jsonify

def register_user_routes(app: Flask) -> None:
    @app.route('/users', methods=['GET'])
    def get_users():
        return jsonify({"users": []})
```

```python
# routes/__init__.py
from .user_routes import register_user_routes

def register_routes(app: Flask) -> None:
    register_test_routes(app)
    register_user_routes(app)  # 添加新路由
```

## 配置

服务器端口通过 `config/default.yaml` 文件中的 `server.port` 配置项控制。
配置文件通过 `core/config/index.py` 模块读取。
